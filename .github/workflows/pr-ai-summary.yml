name: AI PR Summary + Slack Notifier

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

jobs:
  pr-summary-and-slack:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate PR Summary using GitHub CLI (Copilot)
        id: summary
        run: |
          gh extension install github/gh-copilot
          SUMMARY=$(gh copilot pr summarize -R "$GITHUB_REPOSITORY" "$PR_NUMBER" 2>/dev/null || echo "‚ö†Ô∏è Could not generate summary.")
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}

      - name: Format Slack Message
        id: format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          SUMMARY="${{ steps.summary.outputs.summary }}"

          TEXT="ü§ñ *AI Summary of PR*\n‚Ä¢ *Title*: $PR_TITLE\n‚Ä¢ *Author*: $AUTHOR\n‚Ä¢ *Link*: <$PR_URL>\n‚Ä¢ *Summary*: $SUMMARY"
          echo "text<<EOF" >> $GITHUB_OUTPUT
          echo "$TEXT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Slack
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\": \"${{ steps.format.outputs.text }}\"}" \
            $SLACK_WEBHOOK_URL
